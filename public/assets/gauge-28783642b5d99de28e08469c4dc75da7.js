/*!
 * HTML5 Canvas Gauge implementation
 *
 * This code is subject to MIT license.
 *
 * Copyright (c) 2012 Mykhailo Stadnyk <mikhus@gmail.com>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy of
 * this software and associated documentation files (the "Software"), to deal in
 * the Software without restriction, including without limitation the rights to use,
 * copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the
 * Software, and to permit persons to whom the Software is furnished to do so,
 * subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
 * FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
 * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
 * IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
 * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 *
 * @authors: Mykhailo Stadnyk <mikhus@gmail.com>
 *           Chris Poile <poile@edwards.usask.ca>
 *           Luca Invernizzi <http://www.lucainvernizzi.net>
 */
function domReady(e){window.addEventListener?window.addEventListener("DOMContentLoaded",e,!1):window.attachEvent("onload",e)}var Gauge=function(e){function t(e,a){for(var i in a)"object"==typeof a[i]&&"[object Array]"!==Object.prototype.toString.call(a[i])&&"renderTo"!=i?("object"!=typeof e[i]&&(e[i]={}),t(e[i],a[i])):e[i]=a[i]}function a(){A.width=e.width,A.height=e.height,P=A.cloneNode(!0),j=P.getContext("2d"),x=A.width,k=A.height,S=x/2,M=k/2,I=M>S?S:M,P.i8d=!1,j.translate(S,M),j.save(),N.translate(S,M),N.save()}function i(e){var t=new Date;F=setInterval(function(){var a=new Date-t,i=a/e.duration;i>1&&(i=1);var r="function"==typeof e.delta?e.delta:G[e.delta],o=r(i);e.step(o),1==i&&clearInterval(F)},e.delay||10)}function r(){F&&clearInterval(F);var t=V-w,a=w,r=e.animation;i({delay:r.delay,duration:r.duration,delta:r.fn,step:function(e){w=parseFloat(a)+t*e,b.draw()}})}function o(e){return e*Math.PI/180}function n(e,t,a){var i=N.createLinearGradient(0,0,0,a);return i.addColorStop(0,e),i.addColorStop(1,t),i}function l(){var t=93*(I/100),a=I-t,i=91*(I/100),r=88*(I/100);r3=85*(I/100),N.save(),e.glow&&(N.shadowBlur=a,N.shadowColor="rgba(0, 0, 0, 0.5)"),N.beginPath(),N.arc(0,0,t,0,2*Math.PI,!0),N.fillStyle=n("#ddd","#aaa",t),N.fill(),N.restore(),N.beginPath(),N.arc(0,0,i,0,2*Math.PI,!0),N.fillStyle=n("#fafafa","#ccc",i),N.fill(),N.beginPath(),N.arc(0,0,r,0,2*Math.PI,!0),N.fillStyle=n("#eee","#f0f0f0",r),N.fill(),N.beginPath(),N.arc(0,0,r3,0,2*Math.PI,!0),N.fillStyle=e.colors.plate,N.fill(),N.save()}function s(){var t=81*(I/100);N.lineWidth=2,N.strokeStyle=e.colors.majorTicks,N.save();for(var a=0;e.majorTicks.length>a;++a){var i=45+a*(270/(e.majorTicks.length-1));N.rotate(o(i)),N.beginPath(),N.moveTo(0,t),N.lineTo(0,t-15*(I/100)),N.stroke(),N.restore(),N.save()}e.strokeTicks&&(N.rotate(o(90)),N.beginPath(),N.arc(0,0,t,o(45),o(315),!1),N.stroke(),N.restore(),N.save())}function c(){var t=81*(I/100);N.lineWidth=1,N.strokeStyle=e.colors.minorTicks,N.save();for(var a=e.minorTicks*(e.majorTicks.length-1),i=0;a>i;++i){var r=45+i*(270/a);N.rotate(o(r)),N.beginPath(),N.moveTo(0,t),N.lineTo(0,t-7.5*(I/100)),N.stroke(),N.restore(),N.save()}}function f(){for(var t=55*(I/100),a=0;e.majorTicks.length>a;++a){var i=45+a*(270/(e.majorTicks.length-1)),r=d(t,o(i));N.font=20*(I/200)+"px Arial",N.fillStyle=e.colors.numbers,N.lineWidth=0,N.textAlign="center",N.fillText(e.majorTicks[a],r.x,r.y+3)}}function u(){e.title&&(N.save(),N.font=24*(I/200)+"px Arial",N.fillStyle=e.colors.title,N.textAlign="center",N.fillText(e.title,0,-I/4.25),N.restore())}function g(){e.units&&(N.save(),N.font=22*(I/200)+"px Arial",N.fillStyle=e.colors.units,N.textAlign="center",N.fillText(e.units,0,I/3.25),N.restore())}function h(t){var a=e.valueFormat.dec,i=e.valueFormat.int;t=parseFloat(t);var r=0>t;if(t=Math.abs(t),a>0){t=t.toFixed(a).toString().split(".");for(var o=0,n=i-t[0].length;n>o;++o)t[0]="0"+t[0];t=(r?"-":"")+t[0]+"."+t[1]}else{t=Math.round(t).toString();for(var o=0,n=i-t.length;n>o;++o)t="0"+t;t=(r?"-":"")+t}return t}function d(e,t){var a=0,i=e,r=Math.sin(t),o=Math.cos(t),n=a*o-i*r,l=a*r+i*o;return{x:n,y:l}}function v(){N.save();for(var t=81*(I/100),a=t-15*(I/100),i=0,r=e.highlights.length;r>i;i++){var n=e.highlights[i],l=(e.maxValue-e.minValue)/270,s=o(45+(n.from-e.minValue)/l),c=o(45+(n.to-e.minValue)/l);N.beginPath(),N.rotate(o(90)),N.arc(0,0,t,s,c,!1),N.restore(),N.save();var f=d(a,s),u=d(t,s);N.moveTo(f.x,f.y),N.lineTo(u.x,u.y);var g=d(t,c),h=d(a,c);N.lineTo(g.x,g.y),N.lineTo(h.x,h.y),N.lineTo(f.x,f.y),N.closePath(),N.fillStyle=n.color,N.fill(),N.beginPath(),N.rotate(o(90)),N.arc(0,0,a,s-.2,c+.2,!1),N.restore(),N.closePath(),N.fillStyle=e.colors.plate,N.fill(),N.save()}}function m(){var t=12*(I/100),a=8*(I/100),i=77*(I/100),r=20*(I/100),l=4*(I/100),s=2*(I/100),c=function(){N.shadowOffsetX=2,N.shadowOffsetY=2,N.shadowBlur=10,N.shadowColor="rgba(188, 143, 143, 0.45)"};c(),N.save(),0>w?w=Math.abs(e.minValue-w):e.minValue>0?w-=e.minValue:w=Math.abs(e.minValue)+w,N.rotate(o(45+w/((e.maxValue-e.minValue)/270))),N.beginPath(),N.moveTo(-s,-r),N.lineTo(-l,0),N.lineTo(-1,i),N.lineTo(1,i),N.lineTo(l,0),N.lineTo(s,-r),N.closePath(),N.fillStyle=n(e.colors.needle.start,e.colors.needle.end,i-r),N.fill(),N.beginPath(),N.lineTo(-.5,i),N.lineTo(-1,i),N.lineTo(-l,0),N.lineTo(-s,-r),N.lineTo(s/2-2,-r),N.closePath(),N.fillStyle="rgba(255, 255, 255, 0.2)",N.fill(),N.restore(),c(),N.beginPath(),N.arc(0,0,t,0,2*Math.PI,!0),N.fillStyle=n("#f0f0f0","#ccc",t),N.fill(),N.restore(),N.beginPath(),N.arc(0,0,a,0,2*Math.PI,!0),N.fillStyle=n("#e8e8e8","#f5f5f5",a),N.fill()}function p(e,t,a,i,r){N.beginPath(),N.moveTo(e+r,t),N.lineTo(e+a-r,t),N.quadraticCurveTo(e+a,t,e+a,t+r),N.lineTo(e+a,t+i-r),N.quadraticCurveTo(e+a,t+i,e+a-r,t+i),N.lineTo(e+r,t+i),N.quadraticCurveTo(e,t+i,e,t+i-r),N.lineTo(e,t+r),N.quadraticCurveTo(e,t,e+r,t),N.closePath()}function y(){N.save(),N.font=40*(I/200)+"px Led";var e=h(T),t=N.measureText("-"+h(0)).width,a=I-33*(I/100),i=0,r=.12*I;N.save(),p(-t/2-.025*I,a-r-.04*I,t+.05*I,r+.07*I,.025*I);var o=N.createRadialGradient(i,a-.12*I-.025*I+(.12*I+.045*I)/2,I/10,i,a-.12*I-.025*I+(.12*I+.045*I)/2,I/5);o.addColorStop(0,"#888"),o.addColorStop(1,"#666"),N.strokeStyle=o,N.lineWidth=.05*I,N.stroke(),N.shadowBlur=.012*I,N.shadowColor="rgba(0, 0, 0, 1)",N.fillStyle="#babab2",N.fill(),N.restore(),N.shadowOffsetX=.004*I,N.shadowOffsetY=.004*I,N.shadowBlur=.012*I,N.shadowColor="rgba(0, 0, 0, 0.3)",N.fillStyle="#444",N.textAlign="center",N.fillText(e,-i,a),N.restore()}Gauge.Collection.push(this),this.config={renderTo:null,width:200,height:200,title:!1,maxValue:100,minValue:0,majorTicks:["0","20","40","60","80","100"],minorTicks:10,strokeTicks:!0,units:!1,valueFormat:{"int":3,dec:2},glow:!0,animation:{delay:10,duration:250,fn:"cycle"},colors:{plate:"#fff",majorTicks:"#444",minorTicks:"#666",title:"#888",units:"#888",numbers:"#444",needle:{start:"rgba(240, 128, 128, 1)",end:"rgba(255, 160, 122, .9)"}},highlights:[{from:20,to:60,color:"#eee"},{from:60,to:80,color:"#ccc"},{from:80,to:100,color:"#999"}]};var T=0,b=this,w=0,V=0,C=!1;if(this.setValue=function(t){w=e.animation?T:t;var a=(e.maxValue-e.minValue)/100;return V=t>e.maxValue?V=e.maxValue+a:e.minValue>t?e.minValue-a:t,T=t,e.animation?r():this.draw(),this},this.setRawValue=function(e){return w=T=e,this.draw(),this},this.clear=function(){return T=w=V=this.config.minValue,this.draw(),this},this.getValue=function(){return T},this.onready=function(){},t(this.config,e),this.config.minValue=parseFloat(this.config.minValue),this.config.maxValue=parseFloat(this.config.maxValue),e=this.config,w=T=e.minValue,!e.renderTo)throw Error("Canvas element was not specified when creating the Gauge object!");var P,x,k,S,M,I,j,A=e.renderTo.tagName?e.renderTo:document.getElementById(e.renderTo),N=A.getContext("2d");a(),this.updateConfig=function(e){return t(this.config,e),a(),this.draw(),this};var G={linear:function(e){return e},quad:function(e){return Math.pow(e,2)},quint:function(e){return Math.pow(e,5)},cycle:function(e){return 1-Math.sin(Math.acos(e))},bounce:function(e){return 1-function(e){for(var t=0,a=1;1;t+=a,a/=2)if(e>=(7-4*t)/11)return-Math.pow((11-6*t-11*e)/4,2)+Math.pow(a,2)}(1-e)},elastic:function(e){return 1-function(e){var t=1.5;return Math.pow(2,10*(e-1))*Math.cos(20*Math.PI*t/3*e)}(1-e)}},F=null;N.lineCap="round",this.draw=function(){if(!P.i8d){j.clearRect(-S,-M,x,k),j.save();var e=N;N=j,l(),v(),c(),s(),f(),u(),g(),P.i8d=!0,N=e,delete e}if(N.clearRect(-S,-M,x,k),N.save(),N.drawImage(P,-S,-M,x,k),Gauge.initialized)y(),m(),C||(b.onready&&b.onready(),C=!0);else var t=setInterval(function(){Gauge.initialized&&(clearInterval(t),y(),m(),C||(b.onready&&b.onready(),C=!0))},10);return this}};Gauge.initialized=!1,function(){var e,t=document,a=t.getElementsByTagName("head")[0],i=-1!=navigator.userAgent.toLocaleLowerCase().indexOf("msie"),r="http://smart-ip.net/styles/fonts/digital-7-mono."+(i?"eot":"ttf"),o="@font-face {font-family: 'Led';src: url('"+r+"');"+"}",n=t.createElement("style");if(n.type="text/css",i)a.appendChild(n),e=n.styleSheet,e.cssText=o;else{try{n.appendChild(t.createTextNode(o))}catch(l){n.cssText=o}a.appendChild(n),e=n.styleSheet?n.styleSheet:n.sheet||t.styleSheets[t.styleSheets.length-1]}var s=setInterval(function(){if(t.body){clearInterval(s);var e=t.createElement("div");e.style.fontFamily="Led",e.style.position="absolute",e.style.height=e.style.width=0,e.style.overflow="hidden",e.innerHTML=".",t.body.appendChild(e),setTimeout(function(){Gauge.initialized=!0,e.parentNode.removeChild(e)},250)}},1)}(),Gauge.Collection=[],Gauge.Collection.get=function(e){if("string"!=typeof e)return"number"==typeof e?this[e]:null;for(var t=0,a=this.length;a>t;t++)if(this[t].config.renderTo.getAttribute("id")==e)return this[t]},domReady(function(){function toCamelCase(e){for(var t=e[0],a=1,i=e.length;i>a;a++)t+=e[a].substr(0,1).toUpperCase()+e[a].substr(1,e[a].length-1);return t}function trim(e){return e.replace(/^\s+|\s+$/g,"")}for(var c=document.getElementsByTagName("canvas"),i=0,s=c.length;s>i;i++)if("canv-gauge"==c[i].getAttribute("data-type")){var gauge=c[i],config={},prop,w=parseInt(gauge.getAttribute("width")),h=parseInt(gauge.getAttribute("height"));config.renderTo=gauge,w&&(config.width=w),h&&(config.height=h);for(var ii=0,ss=gauge.attributes.length;ss>ii;ii++)if(prop=gauge.attributes.item(ii).nodeName,"data-type"!=prop&&"data-"==prop.substr(0,5)){var cfgProp=prop.substr(5,prop.length-5).toLowerCase().split("-"),attrValue=gauge.getAttribute(prop);if(!attrValue)continue;switch(cfgProp[0]){case"colors":if(cfgProp[1])if(config.colors||(config.colors={}),"needle"==cfgProp[1]){var parts=attrValue.split(/\s+/);config.colors.needle=parts[0]&&parts[1]?{start:parts[0],end:parts[1]}:attrValue}else cfgProp.shift(),config.colors[toCamelCase(cfgProp)]=attrValue;break;case"highlights":config.highlights||(config.highlights=[]),hls=attrValue.split(",");for(var j=0,l=hls.length;l>j;j++){var cfg=trim(hls[j]).split(/\s+/),hlCfg={};cfg[0]&&""!=cfg[0]&&(hlCfg.from=cfg[0]),cfg[1]&&""!=cfg[1]&&(hlCfg.to=cfg[1]),cfg[2]&&""!=cfg[2]&&(hlCfg.color=cfg[2]),config.highlights.push(hlCfg)}break;case"animation":cfgProp[1]&&(config.animation||(config.animation={}),"fn"==cfgProp[1]&&/^\s*function\s*\(/.test(attrValue)&&(attrValue=eval("("+attrValue+")")),config.animation[cfgProp[1]]=attrValue);break;default:var cfgName=toCamelCase(cfgProp);if("onready"==cfgName)continue;if("majorTicks"==cfgName)attrValue=attrValue.split(/\s+/);else if("strokeTicks"==cfgName||"glow"==cfgName)attrValue="true"==attrValue?!0:!1;else if("valueFormat"==cfgName){var val=attrValue.split(".");if(2!=val.length)continue;attrValue={"int":parseInt(val[0]),dec:parseInt(val[1])}}config[cfgName]=attrValue}}var g=new Gauge(config);gauge.getAttribute("data-value")&&g.setRawValue(parseFloat(gauge.getAttribute("data-value"))),gauge.getAttribute("data-onready")&&(g.onready=function(){eval(this.config.renderTo.getAttribute("data-onready"))}),g.draw()}});